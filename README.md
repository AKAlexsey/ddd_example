# CtiKaltura

Реализует редирект клиента на ближайший Edge сервер в CDN сети.

# Amnesia
В качестве базы данных в CtiKaltura используется Amnesia враппер на Elixir вокруг Mnesia.
Позволяет пользоваться Mnesia гораздо удобнее. Например при запросе возвращает структуру а не массив. 
Позволяет делать запрос к таблице по значению поля.
Таблицы описаны в файле `/lib/cti_kaltura/caching/domain_model.ex`
Перед использованием необходимо инициировать базу данных.

```elixir
mix amnesia.create -d DomainModel --disk
```

Это создаст схему а параметр `--disk` указывает на то, что схема будет сохранена на диск.

## Возможные проблемы

### Изменение атрибутов одной из таблиц

Если изменились поля одной из таблиц DomainModel, то операции чтения и записи будут возвращать :badarg.

Решение:

Локально или после деплоя - дропнуть и создать заново схему базу данных.
При этом данные с диска будут удалены. В будущем необходимо написать скрипт. Который совершает эти действия.

```elixir
mix amnesia.drop -d DomainModel
mix amnesia.create -d DomainModel --memory
mix amnesia.create_indexes
```

# Нагрузочное тестирование

Как фреймворк для нагрузочного тестирования используется "k6" https://github.com/loadimpact/k6

Документация доступна по ссылке https://docs.k6.io/docs

Скачайте и установите фреймворк по указаниям на Github.
Сделайте файл k6 исполняемым, чтобы можно было запускать тесты с помошью `k6 --option1 --option2 test_example.com` 

Файлы нагрузочного тестирования находятся в `load_testing/*`

Для проведения проверки live запросов, необходимо запустить
`k6 run --vus 300 --rps 200 --duration 300s load_testing/test_live.js`, где:

* `--vus` - количесво виртуальных пользователей;
* `--rps` - количесво запросов в секунду;
* `--duration` - продолжительность тестирования. Доступные форматы: 40s, 20m40s.

Также доступна возможность строить более сложные сценарии скриптов - разное количество людей, разное количество 
запросов, разная продолжительность тестирования. Для этого используйте опции https://docs.k6.io/docs/options 
Необходимо пометить соответствующие настройки в переменную `options` и запустить тест без параметров. 

# Деплой

Деплой осуществляется при помощи скрипта `deploy.sh`, располагающегося в корне проекта.
Прежде чем задеплоить на стейдж убедитесь что у вас добавлен пароль для удалённого доступа по ssh на:
1. `admintv@10.15.2.20` - для production;
2. `admintv@172.16.2.143` - для stage.

Команды деплоя:
1. Чтобы задеплоить на production - `./deploy.sh prod`.
2. Чтобы задеплоить на stage - `./deploy.sh stage` или `./deploy.sh`.

## Изменения в assets

Если были внесены изменения в ассеты (Добавлены, изменен css или js файлы), необходимо сгенерировать новый дайджест: `mix phx.digest`.
После этого будут внесены изменения в priv/static - необходимо закоммитить изменния и запушить.
После деплоя - изменения будут доступны на сервере.

## Подготовка к деплою

Прежде чем задеплоить проект, необходимо выполнить подготовительные работы на сервере. Необходимо:

1. Создать на стейдж сервере пользователя `admintv`;
2. Установить git;
3. Для пользователя `admintv` установить на стейдж сервер соответствующие версии Elixir и Elrang. 
Указанные в файле `.tool-versions`. На момент написания документации: Elixir - 1.6.3, Erlang - 20.2.2.

4. Установить или использовать имеющуюся Postgres. Добавить необходимую базу данных, которая будет 
использоваться в проекте. Необходимо добавить разрешение на авторизацию в pg_hba.conf:   

`https://stackoverflow.com/questions/7695962/postgresql-password-authentication-failed-for-user-postgres`

5. За пользователя `admintv` создать папку `/home/admintv/cti_kaltura_build/`.
Создать папку `/home/admintv/cti_kaltura_build/build` внутри.

6. Прописать настройки БД и IP в конфигурации для соответствующего окружения для CtiKaltura.Repo, CtiKaltura.Endpoint.
В файл `/home/admintv/cti_kaltura_build/prod.secret.exs` при компиляции он автоматически подхватывается и испоьзуются при
компиляции настроек проекта.

8. Загрузить и настроить NGINX. Ниже описанны настройки и причина почему они должны быть добавлелны:

8.1 Основная причина - только системные утилиты могут быть запущены на порте меньшем 1000.
Следовательно проект должен быть запущен под root пользователем, что плохо.
Вместо этого мы запускаем за пользователя admintv на 4000 и 4001 портах.
* Запросы к 4000 порту не проксируем, если будет необходимо - пользователи зайдут сами по 4000 порту.

Добавить в конфигурацию NGINX секцию:

```
server {
  listen 80;
  server_name _;
}
```

8.2 При проксирвоании через NGINX IP адрес запроса - становится IP адресом NGINX.
Следовательно мы не можем определить IP адрес с которого пришёл запрос.
IP клиента было решено передавать в качетсве `http` заголовка.
Добавить в секцию `server`:

```   
proxy_set_header  Host            $host;
proxy_set_header  X-Real-IP       $remote_addr;
proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
```

Соответственно проект будет читать IP адрес из `X-Real-IP` заголовка, если его нет - из `remote_ip` из %Plug.Conn{}.
При извлечении даных для запроса в `DataReader`.

8.3. Проксирование запросов с 80 порта на 4001 (запросы клиентов). Добавить в секцию `server`:

```
location /btv/live/ {
		proxy_pass http://<project_ip>:4001;
		add_header Access-Control-Allow-Origin *;
		break;
}
    
location /btv/catchup/ {
		proxy_pass http://<project_ip>:4001;
		break;
}
    
location /vod/ {
		proxy_pass http://<project_ip>:4001;
		break;
}
```

8.4. Обрезка расширений при запросах от приставок на `catchup` и `live`.
Приставки отправляют расширение для контента при `catchup` и `live` запросах.
Вида `http://cdn.beetv.kz/btv/live/hls/epg_0.m3p4`, чтобы обрезать расширение.  Добавить в секцию `server`:

```
rewrite ^/btv/live/(.*)/(.*)\.(.*)$ /btv/live/$1/$2 last;
rewrite ^/btv/catchup/(.*)/(.*)\.(.*)$ /btv/catchup/$1/$2 last;
```

8.5. Поддержка https - было решено не реализовывать в проекте https, а перенаправлять его запросы через NGINX.
Добавить отдельную секцию `server` со всеми предыдущими настройками и:

```
listen 443 ssl;
server_name server.domain.name;

ssl_certificate     /path/to/certificate/file.crt;
ssl_certificate_key /path/to/certificate/file.key;
```

9. После этого - можно деплоить. Файл будет задеплоен а папку `/home/admintv/cti_kaltura`. 
* Запуск `/home/admintv/cti_kaltura/bin/cti_kaltura start`;
* Остановка `/home/admintv/cti_kaltura/bin/cti_kaltura stop`;
* Подключиться к работающему проекту `/home/admintv/cti_kaltura/bin/cti_kaltura remote_console`;
* Запустить проект и подключиться к консоли(при выходе проект завершится) `/home/admintv/cti_kaltura/bin/cti_kaltura console`.
