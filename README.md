# CtiKaltura

# CTI интеграция с Kaltura

Nuff said

# Amnesia
В качестве базы данных в KalturaServer используется Amnesia враппер на Elixir вокруг Mnesia.
Позволяет пользоваться Mnesia гораздо удобнее. Например при запросе возвращает структуру а не массив. 
Позволяет делать запрос к таблице по значению поля.
Таблицы описаны в файле `/apps/kaltura_server/lib/caching/domain_model.ex`
Перед использованием необходимо инициировать базу данных.

```elixir
mix amnesia.create -d DomainModel --disk
```

Это создаст схему а параметр `--disk` указывает на то, что схема будет сохранена на диск.

## Возможные проблемы

### Изменение атрибутов одной из таблиц

Если изменились поля одной из таблиц DomainModel, то операции чтения и записи будут возвращать :badarg.

Решение:

Локально или после деплоя - дропнуть и создать заново схему базу данных.
При этом данные с диска будут удалены. В будущем необходимо написать скрипт. Который совершает эти действия.
И при этом делает запрос на получение всех данных KalturaServer из KalturaAdmin

```elixir
mix amnesia.drop -d DomainModel
mix amnesia.create -d DomainModel --memory
mix amnesia.create_indexes
```


### Нагрузочное тестирование

Как фреймворк для нагрузочного тестирования используется "k6" https://github.com/loadimpact/k6

Документация доступна по ссылке https://docs.k6.io/docs

Скачайте и установите фреймворк по указаниям на Github.
Сделайте файл k6 исполняемым, чтобы можно было запускать тесты с помошью `k6 --option1 --option2 test_example.com` 

Файлы нагрузочного тестирования находятся в `load_testing/*`

Для проведения проверки live запросов, необходимо запустить
`k6 run --vus 300 --rps 200 --duration 300s load_testing/test_live.js`, где:

* `--vus` - количесво виртуальных пользователей;
* `--rps` - количесво запросов в секунду;
* `--duration` - продолжительность тестирования. Доступные форматы: 40s, 20m40s.

Также доступна возможность строить более сложные сценарии скриптов - разное количество людей, разное количество 
запросов, разная продолжительность тестирования. Для этого используйте опции https://docs.k6.io/docs/options 
Необходимо пометить соответствующие настройки в переменную `options` и запустить тест без параметров. 
